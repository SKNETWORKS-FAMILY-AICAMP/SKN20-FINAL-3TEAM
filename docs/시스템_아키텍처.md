# 시스템 아키텍처

**SK Networks Family AI Camp 5기**
**프로젝트: 건축 도면 분석 및 법령 안내 시스템**

---

## 1. 컴포넌트 다이어그램

```mermaid
flowchart TB
    subgraph Client["클라이언트"]
        Browser["Chrome Browser"]
        ReactApp["React App<br/>(TypeScript)"]
    end

    subgraph Backend["Backend Server (Port 8080)"]
        SpringBoot["Spring Boot 3.x"]

        subgraph Controllers["Controllers"]
            AuthCtrl["AuthController<br/>/api/auth/*"]
            ChatCtrl["ChatbotController<br/>/api/chatbot/*"]
            FloorCtrl["FloorPlanController<br/>/api/floorplan/*"]
        end

        subgraph Services["Services"]
            AuthSvc["UserService"]
            ChatSvc["ChatbotService"]
            FloorSvc["FloorPlanService"]
        end

        subgraph Security["Security"]
            JWT["JwtUtil"]
            JWTFilter["JwtAuthenticationFilter"]
        end
    end

    subgraph PythonServer["Python Server (Port 8000)"]
        FastAPI["FastAPI"]

        subgraph Endpoints["Endpoints"]
            AnalyzeEP["/analyze<br/>(도면 분석)"]
            AskEP["/ask<br/>(RAG 챗봇)"]
        end

        subgraph AI["AI/ML"]
            VisionAI["Vision AI<br/>(cv_inference)"]
            OpenAI["OpenAI API<br/>(GPT-4o, Embeddings)"]
            RAG["RAG Engine"]
        end
    end

    subgraph Database["PostgreSQL (Port 5432)"]
        PG["PostgreSQL"]
        PGVector["pgvector 확장"]

        subgraph Tables["Tables"]
            Users["users"]
            ChatRoom["ChatRoom"]
            ChatHistory["ChatHistory"]
            FloorPlan["floor_plans"]
            FloorSummary["floorplan_summary"]
            LegalDocs["legal_documents"]
            LandChar["LAND_CHAR"]
            Law["LAW"]
        end
    end

    Browser --> ReactApp
    ReactApp -->|"HTTPS/JSON"| SpringBoot
    SpringBoot --> Controllers
    Controllers --> Services
    Services -->|"REST API"| FastAPI
    FastAPI --> Endpoints
    Endpoints --> AI
    AI --> PG
    Services --> PG
    PG --> PGVector
```

---

## 2. 시퀀스 다이어그램

### 2.1 도면 분석 흐름

```mermaid
sequenceDiagram
    autonumber
    participant User as 사용자
    participant React as React Frontend
    participant Spring as Spring Boot
    participant FastAPI as FastAPI Server
    participant Vision as Vision AI
    participant LLM as sLLM
    participant DB as PostgreSQL

    User->>React: 도면 이미지 업로드
    React->>Spring: POST /api/floorplan/analyze<br/>(multipart/form-data)
    Spring->>FastAPI: POST /analyze<br/>(이미지 파일)

    FastAPI->>Vision: 도면 이미지 분석
    Vision-->>FastAPI: result.json, topology.json

    FastAPI->>LLM: 설계 규칙 평가 요청
    LLM-->>FastAPI: 평가 결과 (eval)

    FastAPI->>FastAPI: 임베딩 벡터 생성
    FastAPI-->>Spring: {elementJson, topologyImage, eval, embedding}
    Spring-->>React: 분석 결과 반환

    React->>React: 도면 시각화<br/>(Bbox/Segmentation 오버레이)
    React-->>User: 분석 결과 표시

    User->>React: 저장 승인
    React->>Spring: POST /api/floorplan/save
    Spring->>DB: FloorPlan 저장
    Spring->>DB: FloorplanSummary 저장<br/>(eval + embedding)
    DB-->>Spring: 저장 완료
    Spring-->>React: 성공 응답
    React-->>User: 저장 완료 알림
```

### 2.2 챗봇 (RAG) 흐름

```mermaid
sequenceDiagram
    autonumber
    participant User as 사용자
    participant React as React Frontend
    participant Spring as Spring Boot
    participant FastAPI as FastAPI Server
    participant OpenAI as OpenAI API
    participant DB as PostgreSQL

    User->>React: 질문 입력<br/>"강남구에서 건축 가능한 용도는?"
    React->>Spring: POST /api/chatbot/chat<br/>{question, chatRoomId?}
    Spring->>FastAPI: POST /ask<br/>{email, question}

    FastAPI->>OpenAI: 질문 임베딩 생성<br/>(text-embedding-3-small)
    OpenAI-->>FastAPI: 질문 벡터 [0.1, 0.2, ...]

    FastAPI->>DB: 벡터 유사도 검색<br/>SELECT * FROM legal_documents<br/>ORDER BY embedding <=> query LIMIT 3
    DB-->>FastAPI: 관련 법령 문서

    FastAPI->>DB: 토지 특성 조회<br/>SELECT * FROM LAND_CHAR<br/>WHERE query_key = ?
    DB-->>FastAPI: 용도지역 정보

    FastAPI->>OpenAI: GPT-4o 답변 생성<br/>(컨텍스트 + 질문)
    OpenAI-->>FastAPI: {summaryTitle, answer}

    FastAPI-->>Spring: {summaryTitle, answer}

    Spring->>DB: ChatRoom 생성/조회
    Spring->>DB: ChatHistory 저장
    DB-->>Spring: 저장 완료

    Spring-->>React: answer
    React-->>User: AI 답변 표시
```

### 2.3 인증 흐름

```mermaid
sequenceDiagram
    autonumber
    participant User as 사용자
    participant React as React Frontend
    participant Spring as Spring Boot
    participant JWT as JwtUtil
    participant DB as PostgreSQL

    User->>React: 로그인 정보 입력
    React->>Spring: POST /api/auth/login<br/>{email, password}

    Spring->>DB: 사용자 조회
    DB-->>Spring: User 정보

    Spring->>Spring: 비밀번호 검증
    Spring->>JWT: JWT 토큰 생성
    JWT-->>Spring: token

    Spring-->>React: {token, email, username, role}
    React->>React: localStorage에 토큰 저장
    React-->>User: 로그인 성공

    Note over React,Spring: 이후 모든 API 요청
    React->>Spring: Authorization: Bearer {token}
    Spring->>JWT: 토큰 검증
    JWT-->>Spring: 사용자 정보
    Spring->>Spring: Security Context 설정
```

---

## 3. 액티비티 다이어그램

### 3.1 도면 분석 프로세스

```mermaid
flowchart TD
    Start([시작]) --> Upload[사용자: 도면 이미지 업로드]
    Upload --> Validate{파일 형식 검증<br/>PNG/JPG?}

    Validate -->|No| Error1[오류: 지원하지 않는 형식]
    Error1 --> Upload

    Validate -->|Yes| SendBackend[Frontend → Backend 전송]
    SendBackend --> SendPython[Backend → Python 서버 전송]

    SendPython --> VisionAnalysis[Vision AI 분석]
    VisionAnalysis --> GenerateJSON[topology.json 생성]

    GenerateJSON --> ExtractData[Data Extractor<br/>정량값 추출]
    ExtractData --> SaveStats[(PostgreSQL 저장<br/>bay_count, area_ratio)]

    GenerateJSON --> ComplianceCheck[Compliance sLLM<br/>설계 규칙 평가]
    ComplianceCheck --> EvalResult[개별 평가 결과 생성]

    EvalResult --> MergeEval[Merge Evaluations<br/>통합 평가 텍스트]
    SaveStats --> MergeEval

    MergeEval --> GenerateEmbed[임베딩 벡터 생성]
    GenerateEmbed --> ReturnResult[결과 반환]

    ReturnResult --> DisplayResult[Frontend: 결과 시각화]
    DisplayResult --> UserReview{사용자 검토}

    UserReview -->|수정 필요| Upload
    UserReview -->|승인| SaveDB[DB 저장]

    SaveDB --> SaveFloorPlan[(FloorPlan 테이블)]
    SaveDB --> SaveSummary[(FloorplanSummary 테이블)]
    SaveDB --> SaveVector[(VectorDB 저장)]

    SaveFloorPlan --> End([완료])
    SaveSummary --> End
    SaveVector --> End
```

### 3.2 챗봇 RAG 프로세스

```mermaid
flowchart TD
    Start([시작]) --> Input[사용자: 질문 입력]
    Input --> CheckRoom{기존 채팅방?}

    CheckRoom -->|Yes| UseRoom[기존 ChatRoom 사용]
    CheckRoom -->|No| CreateRoom[새 ChatRoom 생성]

    UseRoom --> SendQuestion[질문 전송]
    CreateRoom --> SendQuestion

    SendQuestion --> EmbedQuestion[질문 임베딩 생성<br/>OpenAI API]

    EmbedQuestion --> SearchLegal[법령 문서 검색<br/>legal_documents]
    EmbedQuestion --> SearchLand[토지 정보 검색<br/>LAND_CHAR]
    EmbedQuestion --> SearchInternal[내부 문서 검색<br/>internal_eval]

    SearchLegal --> BuildContext[컨텍스트 구성]
    SearchLand --> BuildContext
    SearchInternal --> BuildContext

    BuildContext --> CallLLM[LLM 호출<br/>GPT-4o]
    CallLLM --> GenerateAnswer[답변 생성]

    GenerateAnswer --> SaveHistory[(ChatHistory 저장)]
    SaveHistory --> DisplayAnswer[답변 표시]
    DisplayAnswer --> End([완료])
```

---

## 4. 전체 시스템 아키텍처

```mermaid
flowchart TB
    subgraph UserLayer["사용자 계층"]
        User["사용자"]
    end

    subgraph PresentationLayer["프레젠테이션 계층 (Port 3000)"]
        subgraph ReactApp["React Application"]
            AuthUI["인증 UI"]
            ChatUI["채팅 UI"]
            FloorUI["도면 분석 UI"]
            AdminUI["관리자 UI"]
        end
    end

    subgraph ApplicationLayer["애플리케이션 계층 (Port 8080)"]
        subgraph SpringBoot["Spring Boot"]
            AuthAPI["Auth API"]
            ChatAPI["Chatbot API"]
            FloorAPI["FloorPlan API"]
            AdminAPI["Admin API"]
        end

        subgraph BusinessLogic["비즈니스 로직"]
            UserSvc["UserService"]
            ChatSvc["ChatbotService"]
            FloorSvc["FloorPlanService"]
        end
    end

    subgraph AILayer["AI 처리 계층 (Port 8000)"]
        subgraph FastAPI["FastAPI Server"]
            AnalyzeAPI["/analyze"]
            AskAPI["/ask"]
        end

        subgraph AIModels["AI 모델"]
            VisionAI["Vision AI<br/>(cv_inference_V3.6.2)"]
            SummaryLLM["Summary sLLM"]
            AnswerLLM["Answer sLLM"]
            Embedder["Embedding Model"]
        end

        subgraph Agents["에이전트"]
            AgentA["Agent A<br/>Design Analysis"]
            AgentB["Agent B<br/>Search/Indexing"]
        end
    end

    subgraph DataLayer["데이터 계층 (Port 5432)"]
        subgraph PostgreSQL["PostgreSQL + pgvector"]
            UserDB[("users")]
            ChatDB[("ChatRoom<br/>ChatHistory")]
            FloorDB[("floor_plans<br/>floorplan_summary")]
            LegalDB[("legal_documents<br/>LAW")]
            LandDB[("LAND_CHAR")]
            InternalDB[("internal_eval")]
        end
    end

    subgraph ExternalServices["외부 서비스"]
        OpenAI["OpenAI API<br/>(GPT-4o, Embeddings)"]
    end

    User --> ReactApp
    ReactApp --> SpringBoot
    SpringBoot --> BusinessLogic
    BusinessLogic --> FastAPI
    FastAPI --> AIModels
    AIModels --> Agents
    Agents --> PostgreSQL
    BusinessLogic --> PostgreSQL
    AIModels --> OpenAI
```

---

## 5. 데이터베이스 ERD

```mermaid
erDiagram
    users ||--o{ ChatRoom : "has"
    users ||--o{ floor_plans : "owns"
    ChatRoom ||--o{ ChatHistory : "contains"
    floor_plans ||--|| floorplan_summary : "has"

    users {
        Long id PK
        String email UK
        String pw
        String name
        String phonenumber
        String role
        LocalDate create_at
        LocalDate update_at
    }

    ChatRoom {
        Long id PK
        Long user_id FK
        String name
        LocalDate create_at
    }

    ChatHistory {
        Long id PK
        Long chatroom_id FK
        String question
        String answer
        LocalDate create_at
    }

    floor_plans {
        Long id PK
        Long user_id FK
        String name
        String imageUrl
        JSONB elementJson
        LocalDate create_at
    }

    floorplan_summary {
        Long id PK
        Long floorplan_id FK
        String eval
        Vector embedding
    }

    LAND_CHAR {
        String legal_dong_code
        String legal_dong_name
        String lot_number
        String zone1
        String zone2
        String query_key
        String region_code
    }

    LAW {
        Long id PK
        String region_code
        String zone_district_name
        String law_name
        String permission_status
        String condition_exception
    }

    legal_documents {
        Long id PK
        String region
        Text content
        JSONB metadata
        Vector embedding
    }

    internal_eval {
        Long id PK
        Text content
        Vector embedding
    }
```

---

## 6. 배포 구성도

```mermaid
flowchart LR
    subgraph Local["로컬 개발 환경"]
        Dev["개발자"]
    end

    subgraph Server["서버 구성"]
        subgraph Frontend["Frontend Server"]
            Vite["Vite Dev Server<br/>:3000"]
        end

        subgraph Backend["Backend Server"]
            Spring["Spring Boot<br/>:8080"]
        end

        subgraph Python["Python Server"]
            FastAPI["FastAPI<br/>:8000"]
        end

        subgraph DB["Database Server"]
            PG["PostgreSQL<br/>:5432"]
        end
    end

    subgraph External["외부 서비스"]
        OpenAI["OpenAI API"]
    end

    Dev --> Vite
    Vite --> Spring
    Spring --> FastAPI
    Spring --> PG
    FastAPI --> PG
    FastAPI --> OpenAI
```

---

## 7. 기술 스택

| 계층 | 기술 | 버전 |
|------|------|------|
| **Frontend** | React | 18.x |
| | TypeScript | 5.x |
| | Vite | 5.x |
| | Axios | - |
| **Backend** | Spring Boot | 3.x |
| | Spring Security | - |
| | Spring Data JPA | - |
| | JWT | - |
| **Python** | FastAPI | - |
| | OpenAI API | GPT-4o |
| | psycopg2 | - |
| **Database** | PostgreSQL | 12+ |
| | pgvector | - |
| **AI/ML** | Vision AI | cv_inference_V3.6.2 |
| | Embeddings | text-embedding-3-small |

---

## 8. API 엔드포인트 요약

### Frontend → Backend

| 엔드포인트 | 메서드 | 설명 |
|-----------|--------|------|
| `/api/auth/login` | POST | 로그인 |
| `/api/auth/signup` | POST | 회원가입 |
| `/api/auth/me` | GET | 현재 사용자 정보 |
| `/api/chatbot/chat` | POST | 채팅 질문/답변 |
| `/api/chatbot/sessionuser` | POST | 채팅방 목록 |
| `/api/chatbot/roomhistory` | POST | 채팅 기록 |
| `/api/floorplan/analyze` | POST | 도면 분석 |
| `/api/floorplan/save` | POST | 분석 결과 저장 |

### Backend → Python

| 엔드포인트 | 메서드 | 설명 |
|-----------|--------|------|
| `/analyze` | POST | 도면 이미지 분석 |
| `/ask` | POST | RAG 질의응답 |

---

*작성일: 2025.02*
